# Romance Configuration Reference

Complete reference for the `romance.toml` configuration file, environment overrides, and environment variables.

---

## Table of Contents

- [romance.toml Overview](#romancetoml-overview)
- [project Section](#project-section)
- [backend Section](#backend-section)
- [frontend Section](#frontend-section)
- [codegen Section](#codegen-section)
- [features Section](#features-section)
- [security Section](#security-section)
- [storage Section](#storage-section)
- [environment Section](#environment-section)
- [Environment Overrides](#environment-overrides)
- [Environment Variables (.env)](#environment-variables-env)
- [Complete Example](#complete-example)

---

## romance.toml Overview

The `romance.toml` file is the central configuration file for a Romance project. It is created by `romance new` in the project root directory and is read by both the CLI tool and the generated backend application.

**Default file generated by `romance new`:**

```toml
[project]
name = "my-app"

[backend]
port = 3001
database_url = "postgres://localhost/my_app"

[frontend]
port = 5173
api_base_url = "http://localhost:3001"

[codegen]
generate_openapi = true
generate_ts_types = true

[features]
# Enable with: romance add <feature>
# validation = true
# soft_delete = true
# audit_log = true
# search = true
```

---

## [project] Section

Basic project metadata.

| Key | Type | Required | Default | Description |
|-----|------|----------|---------|-------------|
| `name` | String | Yes | -- | Project name. Used in generated code, Cargo.toml, package.json. |
| `description` | String | No | `null` | Optional project description. |

```toml
[project]
name = "my-blog"
description = "A blogging platform built with Romance"
```

---

## [backend] Section

Backend server configuration.

| Key | Type | Required | Default | Description |
|-----|------|----------|---------|-------------|
| `port` | Integer | Yes | `3001` | Port the Axum server listens on. |
| `database_url` | String | Yes | `"postgres://localhost/{project_name_snake}"` | PostgreSQL connection string. |
| `api_prefix` | String | No | `null` | API route prefix for versioning (e.g., `"/api/v1"`). When set, all generated entity routes are nested under this prefix. |

```toml
[backend]
port = 3001
database_url = "postgres://localhost/my_blog"
api_prefix = "/api/v1"
```

**Notes:**
- The `database_url` in `romance.toml` is used by the CLI for configuration reference. The actual runtime database URL is read from the `DATABASE_URL` environment variable (see [Environment Variables](#environment-variables-env)).
- When `api_prefix` is not set (the default), routes are generated at the root level (e.g., `/api/products`).

---

## [frontend] Section

Frontend development server configuration.

| Key | Type | Required | Default | Description |
|-----|------|----------|---------|-------------|
| `port` | Integer | Yes | `5173` | Port the Vite dev server listens on. |
| `api_base_url` | String | Yes | `"http://localhost:3001"` | Backend API base URL used by the frontend API client. |

```toml
[frontend]
port = 5173
api_base_url = "http://localhost:3001"
```

---

## [codegen] Section

Code generation behavior settings. This section is optional. When the section is present but individual fields are omitted, they default to `true`. When the entire section is omitted, all fields default to `false`.

| Key | Type | Default (section present) | Default (section omitted) | Description |
|-----|------|--------------------------|--------------------------|-------------|
| `generate_openapi` | Boolean | `true` | `false` | Generate OpenAPI annotations in handlers and include Swagger UI. |
| `generate_ts_types` | Boolean | `true` | `false` | Generate TypeScript type definitions via ts-rs. |

```toml
[codegen]
generate_openapi = true
generate_ts_types = true
```

**Behavior detail:**

```toml
# Section present, fields omitted -> both default to true
[codegen]

# Section absent entirely -> both default to false
# (no [codegen] section)

# Explicit values override defaults
[codegen]
generate_openapi = true
generate_ts_types = false
```

---

## [features] Section

Feature flags that track which addons have been installed. These are typically set automatically by `romance add` commands, but can also be set manually. All flags default to `false` when omitted.

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `validation` | Boolean | `false` | Whether the validation addon is installed (backend: validator, frontend: Zod). |
| `soft_delete` | Boolean | `false` | Whether soft-delete support is enabled (deleted_at column, restore endpoints). |
| `audit_log` | Boolean | `false` | Whether audit logging is active (tracks create/update/delete with user attribution). |
| `search` | Boolean | `false` | Whether full-text search (PostgreSQL tsvector + GIN) is enabled. |

```toml
[features]
validation = true
soft_delete = true
audit_log = false
search = true
```

**Checking features programmatically:**

The `RomanceConfig` struct provides a `has_feature(name)` method that returns `true` or `false` for any known feature name. Unknown feature names always return `false`.

---

## [security] Section

Security middleware configuration. This section is optional and is typically added by `romance add security`.

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `rate_limit_rpm` | Integer | `60` | Maximum requests per minute for rate limiting. |
| `cors_origins` | Array of Strings | `["http://localhost:5173"]` | Allowed CORS origins. Set to `[]` in production to disallow all cross-origin requests (or specify your production domain). |
| `csrf` | Boolean | `false` | Whether CSRF protection is enabled. |

```toml
[security]
rate_limit_rpm = 100
cors_origins = ["http://localhost:5173", "https://my-app.example.com"]
csrf = true
```

**Production override example (in `romance.production.toml`):**

```toml
[security]
rate_limit_anon_rpm = 30
rate_limit_auth_rpm = 120
cors_origins = []
```

---

## [storage] Section

File and image upload configuration. This section is optional and is typically added by `romance add storage`.

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `backend` | String | `"local"` | Storage backend. Supported values: `"local"` (filesystem), `"s3"` (Amazon S3 or compatible). |
| `upload_dir` | String | `"./uploads"` | Local directory for file uploads (used when backend is `"local"`). |
| `max_file_size` | String | `"10MB"` | Maximum allowed upload file size. |

```toml
[storage]
backend = "local"
upload_dir = "./uploads"
max_file_size = "10MB"
```

**S3 configuration:**

```toml
[storage]
backend = "s3"
max_file_size = "50MB"
```

When using S3, additional environment variables are required (see [Environment Variables](#environment-variables-env)).

---

## [environment] Section

Environment selection for configuration overrides.

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `active` | String | `"development"` | The active environment name. Determines which override file to load. Can be overridden by the `ROMANCE_ENV` environment variable. |

```toml
[environment]
active = "development"
```

**Resolution order:**

1. The `ROMANCE_ENV` environment variable takes highest priority
2. If not set, the `[environment] active` value in `romance.toml` is used
3. If neither is set, defaults to `"development"`

---

## Environment Overrides

Romance supports per-environment configuration overrides through additional TOML files. Override files are named `romance.{environment}.toml` and are deep-merged on top of the base `romance.toml`.

**How it works:**

1. The base `romance.toml` is loaded
2. The active environment is determined (via `ROMANCE_ENV` or `[environment] active`)
3. If `romance.{environment}.toml` exists, its values are deep-merged into the base config
4. Tables are merged recursively; scalar values are replaced by the override

**Default production override file (`romance.production.toml`):**

```toml
# Production overrides -- values here override romance.toml
# Activated by setting ROMANCE_ENV=production or [environment] active = "production"

[backend]
port = 8080

[security]
rate_limit_anon_rpm = 30
rate_limit_auth_rpm = 120
cors_origins = []

[storage]
backend = "s3"
```

**Example: staging environment**

Create a file `romance.staging.toml`:

```toml
[backend]
port = 4000
database_url = "postgres://staging-host:5432/my_app_staging"
```

Activate it:

```bash
# Via environment variable
ROMANCE_ENV=staging romance dev

# Or in romance.toml
[environment]
active = "staging"
```

**Deep merge behavior:**

Only the keys present in the override file are replaced. All other keys from the base config are preserved.

```toml
# Base romance.toml
[backend]
port = 3001
database_url = "postgres://localhost/my_app"

[features]
validation = true

# romance.staging.toml
[backend]
port = 4000

# Result after merge:
# backend.port = 4000            (overridden)
# backend.database_url = "..."   (preserved from base)
# features.validation = true     (preserved from base)
```

---

## Environment Variables (.env)

The backend application reads environment variables from `backend/.env` at startup (via the `dotenvy` crate). A template is generated at `backend/.env.example`.

### Required Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `DATABASE_URL` | `postgres://localhost/{project_name_snake}` | PostgreSQL connection string. This is the primary database connection used at runtime. |
| `PORT` | `3001` | Port the backend server binds to. |
| `JWT_SECRET` | `romance-dev-secret-change-in-production` | Secret key for signing JWT tokens. **Must be changed in production.** |

### Optional Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `RUST_LOG` | `info` | Log level filter. Uses the `tracing_subscriber::EnvFilter` format. Examples: `info`, `debug`, `info,my_app_backend=debug,tower_http=debug`. |
| `CORS_ORIGIN` | `http://localhost:5173` | Allowed CORS origin for the backend. Set to your production frontend URL in production. |
| `REDIS_URL` | `redis://localhost:6379` | Redis connection string. Used by the cache addon and Docker Compose. |

### Addon-specific Variables

These variables are relevant when specific addons are installed:

| Variable | Addon | Description |
|----------|-------|-------------|
| `S3_BUCKET` | storage | S3 bucket name |
| `S3_REGION` | storage | AWS region |
| `S3_ACCESS_KEY` | storage | AWS access key ID |
| `S3_SECRET_KEY` | storage | AWS secret access key |
| `OAUTH_GOOGLE_CLIENT_ID` | oauth | Google OAuth client ID |
| `OAUTH_GOOGLE_CLIENT_SECRET` | oauth | Google OAuth client secret |
| `OAUTH_GITHUB_CLIENT_ID` | oauth | GitHub OAuth client ID |
| `OAUTH_GITHUB_CLIENT_SECRET` | oauth | GitHub OAuth client secret |
| `OAUTH_DISCORD_CLIENT_ID` | oauth | Discord OAuth client ID |
| `OAUTH_DISCORD_CLIENT_SECRET` | oauth | Discord OAuth client secret |
| `SMTP_HOST` | email | SMTP server hostname |
| `SMTP_PORT` | email | SMTP server port |
| `SMTP_USER` | email | SMTP username |
| `SMTP_PASSWORD` | email | SMTP password |
| `FROM_EMAIL` | email | Default sender email address |

### Default .env File

Generated by `romance new`:

```env
DATABASE_URL=postgres://localhost/my_app
PORT=3001
JWT_SECRET=romance-dev-secret-change-in-production
RUST_LOG=info
CORS_ORIGIN=http://localhost:5173
```

---

## Complete Example

A fully configured `romance.toml` with all sections:

```toml
[project]
name = "my-ecommerce"
description = "An e-commerce platform"

[backend]
port = 3001
database_url = "postgres://localhost/my_ecommerce"
api_prefix = "/api/v1"

[frontend]
port = 5173
api_base_url = "http://localhost:3001"

[codegen]
generate_openapi = true
generate_ts_types = true

[features]
validation = true
soft_delete = true
audit_log = true
search = true

[security]
rate_limit_rpm = 100
cors_origins = ["http://localhost:5173"]
csrf = false

[storage]
backend = "local"
upload_dir = "./uploads"
max_file_size = "25MB"

[environment]
active = "development"
```

With a production override at `romance.production.toml`:

```toml
[backend]
port = 8080

[security]
rate_limit_anon_rpm = 30
rate_limit_auth_rpm = 120
cors_origins = ["https://my-ecommerce.example.com"]

[storage]
backend = "s3"
max_file_size = "50MB"
```

And the corresponding production `backend/.env`:

```env
DATABASE_URL=postgres://prod-user:prod-pass@db.example.com:5432/my_ecommerce
PORT=8080
JWT_SECRET=a-long-random-secret-generated-with-openssl-rand-base64-64
RUST_LOG=info
CORS_ORIGIN=https://my-ecommerce.example.com
S3_BUCKET=my-ecommerce-uploads
S3_REGION=us-east-1
S3_ACCESS_KEY=AKIA...
S3_SECRET_KEY=...
```
